<%= javascript_include_tag "//maps.google.com/maps/api/js?key=#{ENV['GOOGLE_MAPS']}" %> 
<div id="map" style="width: 500px; height: 400px;"></div>
<div class="testing"></div>
<script type="text/javascript">

    var maps = new google.maps.Map(document.getElementById('map'), {
        zoom: 4,
        center: new google.maps.LatLng(44.99, -98.5),
        mapTypeId: google.maps.MapTypeId.ROADMAP
    });

    locations = [];
    floors = [];
    names = [];
    nb_batteries = [];
    nb_columns = [];
    nb_elevators = [];
    tech_names = [];
    <% Building.last(10).each do |building| %>
        var f=0, x=0, y=0, z=0;
        locations.push(<%= raw(building.address_building.to_json) %>);
        names.push(<%= raw(building.customer.company_name.to_json) %>);
        tech_names.push(<%= raw(building.customer.full_name_company_contact.to_json) %>);
        x = x + <%= building.batteries.count %>;
        <% building.batteries.all.each do |battery| %>
            y = y + <%= battery.columns.count %>;
            <% battery.columns.all.each do |column| %>
                f = f + <%= column.number_of_floors_served %>;
                z = z + <%= column.elevators.count %>;
            <% end %>
        <% end %>
        floors.push(f);
        nb_batteries.push(x);
        nb_columns.push(y);
        nb_elevators.push(z);
    <% end %>

    var geocoder = new google.maps.Geocoder();
    var infowindow = new google.maps.InfoWindow();
    var marker, i;
    let n = 0;
    var selectLoc = locations.slice(0, 10);

    console.log('First address Reference: ' + locations[0]);
    // console.log(selectLoc)

    
    //--------------------- TESTING -------------------
    while (n < 10) {
        
    geocoder.geocode({ address: String(locations[n]) }, (results, status) => {
        
        console.log('Addresses After Geocode: ' + locations[n]);
                
        if (status === "OK") {
            maps.setCenter(results[0].geometry.location);
            marker = new google.maps.Marker({
                map: maps,
                position: results[0].geometry.location,
                });
                google.maps.event.addListener(marker, 'click', (function(marker, i) {
                    return function() {
                         infowindow.setContent('<b>' + locations[n] + '</b>' 
                        + '<br>' + names[n]
                        + '<br> <br>' + 'Floors: ' + floors[n]
                        + '<br>' + 'Batteries: ' + nb_batteries[n]
                        + '<br>' + 'Columns: ' + nb_columns[n]
                        + '<br>' + 'Elevators: ' + nb_elevators[n]
                        + '<br>' + 'Technical Contact: ' + tech_names[n]);
                        infowindow.open(map, marker);
                    }
                })(marker, i));
                // console.log('Addresses After Geocode: ' + locations[i]);
            } else {
            alert("Geocode was not successful for the following reason: " + status);
        }
    });


        

        // geocoder.geocode({ address: locations[2] }, (results, status) => {
    
        //     // console.log('Addresses After Geocode: ' + locations[2]);
            
        //     if (status === "OK") {
        //             maps.setCenter(results[0].geometry.location);
        //             marker = new google.maps.Marker({
        //                 map: maps,
        //                 position: results[0].geometry.location,
        //             });
        //             google.maps.event.addListener(marker, 'click', (function(marker, i) {
        //                 return function() {
        //                     infowindow.setContent('<b>' + locations[2] + '</b>' 
        //                     + '<br>' + names[2]
        //                     + '<br> <br>' + 'Floors: ' + floors[2]
        //                     + '<br>' + 'Batteries: ' + nb_batteries[2]
        //                     + '<br>' + 'Columns: ' + nb_columns[2]
        //                     + '<br>' + 'Elevators: ' + nb_elevators[2]
        //                     + '<br>' + 'Technical Contact: ' + tech_names[2]);
        //                     infowindow.open(map, marker);
        //                 }
        //             })(marker, i));
        //             // console.log('Addresses After Geocode: ' + locations[i]);
        //         } else {
        //         alert("Geocode was not successful for the following reason: " + status);
        //     }
        // });
    //--------------------- TESTING --------------------

    // for (i = 0; i < 10; i++) {
    //     console.log('Addresses In The Loop: ' + locations[i]);
    //     console.log(i)
    //     geocoder.geocode({ address: locations[i] }, (results, status) => {

    //         console.log('Addresses After Geocode: ' + locations[i]);
        
    //         if (status === "OK") {
    //             maps.setCenter(results[0].geometry.location);
    //             marker = new google.maps.Marker({
    //                 map: maps,
    //                 position: results[0].geometry.location,
    //             });
    //             google.maps.event.addListener(marker, 'click', (function(marker, i) {
    //                 return function() {
    //                     infowindow.setContent('<b>' + locations[i] + '</b>' 
    //                     + '<br>' + names[i]
    //                     + '<br> <br>' + 'Floors: ' + floors[i]
    //                     + '<br>' + 'Batteries: ' + nb_batteries[i]
    //                     + '<br>' + 'Columns: ' + nb_columns[i]
    //                     + '<br>' + 'Elevators: ' + nb_elevators[i]
    //                     + '<br>' + 'Technical Contact: ' + tech_names[i]);
    //                     infowindow.open(map, marker);
    //                 }
    //             })(marker, i));
    //             // console.log('Addresses After Geocode: ' + locations[i]);
    //         } else {
    //         alert("Geocode was not successful for the following reason: " + status);
    //         }
    //     });

    // }

</script>