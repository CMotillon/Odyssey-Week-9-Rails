<script src="//maps.google.com/maps/api/js?key=AIzaSyCeKrWjY27iJdFKVh1Sat1SBknwXV3OBoI"></script>  
<div id="map" style="width: 500px; height: 400px;"></div>
<div class="testing"></div>
<script type="text/javascript">
    //Draw map with center on USA 
    var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 4,
        center: new google.maps.LatLng(44.99, -98.5),
        mapTypeId: google.maps.MapTypeId.ROADMAP
    });
    //Declare infowindow to show when click on marker 
    var infowindow = new google.maps.InfoWindow();
    var marker, i=0;
    //Loop on Building list 
    //Building refers to app/controllers/buildings_controllers.rb
    <% Building.all.each do |building| %>
        //initialize variables 
        var f=0, x=0, y=0, z=0;
        var geocoder = new google.maps.Geocoder();    
        //get address value 
        var address = <%= raw(building.address_building.to_json) %>;

        //full name of technical contact 
        //tech_name = building.
        //compute floors, batteries, columns and elevators for each building 
        x = x + <%= building.batteries.count %>;
        //Loop to get each battery in the current building 
        <% building.batteries.all.each do |battery| %>
            //increment column
            y = y + <%= battery.columns.count %>;
            //Loop to get each column in the battery 
            <% battery.columns.all.each do |column| %>
                //increment the total number of floors 
                f = f + <%= column.number_of_floors_served %>;
                //increment the total number of elevators 
                z = z + <%= column.elevators.count %>;
            <% end %>
        <% end %>


        //convert address to longitude and latitude value using Google API  Geocode and draw markers 

        resGecode =  geocoder.geocode( { 'address': address}, function(results, status) {
            //check if the operation is well done 
            if (status == google.maps.GeocoderStatus.OK) {
                //get lattitude value 
                var lat = results[0].geometry.location.lat();
                //get longitude value 
                var long = results[0].geometry.location.lng();
                marker = new google.maps.Marker({
                //set position Lat=locations[i][0] and Long=Locations[i][1]    
                position: new google.maps.LatLng(lat, long),
                map: map
                });
                //Add a listner if click on a marker => Show window 
                google.maps.event.addListener(marker, 'click', (function(marker, i) {
                return function() {
                    //show building details 
                    infowindow.setContent('<b>' + address + '</b>' 
//                    + '<br>' + building.customer.to_json
                    + '<br> <br>' + 'floors: ' + f
                    + '<br>' + 'batteries: ' + x
                    + '<br>' + 'columns: ' + y
                    + '<br>' + 'elevators: ' + z
          /*          + '<br>' + 'technical contact: ' + tech_names[i].tech_full_name */); 
                    infowindow.open(map, marker);
                }
                })(marker, i));
            }
        });
        i=i+1;





    <% end %>

//The below section was commented becaus asynchronus call of gecode method 
//The locations array is correctly filled in the gecode method 


/*    //Check the locations content 
    //the array is full 
    console.log(locations);
    //but the length is 0 !!!!
    console.log(locations.length);

    //Adding markers to the map 
    for (i = 0; i < locations.length; i++) { 
        console.log("add marker"); 
        marker = new google.maps.Marker({
        //set position Lat=locations[i][0] and Long=Locations[i][1]    
        position: new google.maps.LatLng(locations[i][0], locations[i][1]),
        map: map
        });
        //Add a listner if click on a marker => Show window 
        google.maps.event.addListener(marker, 'click', (function(marker, i) {
        return function() {
            //show building details 
            infowindow.setContent('<b>' + locations[i].number_n_street + '</b>' 
            + '<br>' + names[i].company_name
            + '<br> <br>' + 'floors: ' + floors[i]
            + '<br>' + 'batteries: ' + nb_batteries[i]
            + '<br>' + 'columns: ' + nb_columns[i]
            + '<br>' + 'elevators: ' + nb_elevators[i]
            + '<br>' + 'technical contact: ' + tech_names[i].tech_full_name);
            infowindow.open(map, marker);
        }
        })(marker, i));
    }
    */
</script>